<!DOCTYPE html>
<html lang="en">
<head>
  <title>Blog site demonstration</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body onload="signal_taler_wallet_onload()">
  <header>
    <div id="logo">
      <svg height="100" width="100">
        <circle cx="50" cy="50" r="40" stroke="darkcyan" stroke-width="6" fill="white" />
        <text x="19" y="82" font-family="Verdana" font-size="90" fill="darkcyan">B</text>
      </svg>
    </div>

    <h1>Blog site demonstration</h1>
  </header>

  <aside class="sidebar" id="left">
  </aside>

  <section id="main">
    <article>
      <h1>Welcome to the Taler blog</h1>
      <p>This blog simulates how a website selling articles which integrates
         Taler should work. If you don't have a Taler wallet installed,
	 please visit <a href="https://demo.taler.net">demo.taler.net</a>.
         By clicking on some article below, you get its teaser shown, but the
	 actual purchase happens once you will click on the 'read more' link
	 associated with that teaser.
      </p>
    </article>
    <section>

      <article>
        <h2>Articles list</h2>
      </article>

      <article class="articles">
        <ul style="list-style-type:none">
	  <li>
	    <a href="/cc_payment.php?article=essay-x" class="read-more" id="essay-x">
	      <div class="teasers_item">
	        <h3>Essay x</h3>
	        <p>In essay x, we will ...</p>
	      </div>
	    </a>
	    </li>
	</ul>
      </article>
    </section>
  </section>
</body>
<script type="text/javascript">
/* @licstart  The following is the entire license notice for the
  JavaScript code in this page.

  Copyright (C) 2015 GNUnet e.V.

  The JavaScript code in this page is free software: you can
  redistribute it and/or modify it under the terms of the GNU
  Lesser General Public License (GNU LGPL) as published by the Free Software
  Foundation, either version 2.1 of the License, or (at your option)
  any later version.  The code is distributed WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS
  FOR A PARTICULAR PURPOSE.  See the GNU LGPL for more details.

  As additional permission under GNU LGPL version 2.1 section 7, you
  may distribute non-source (e.g., minimized or compacted) forms of
  that code without the copy of the GNU LGPL normally required by
  section 4, provided you include this license notice and a URL
  through which recipients can access the Corresponding Source.

  @licend  The above is the entire license notice
  for the JavaScript code in this page.
  */

/* This function is called from "taler_pay" after
   we downloaded the JSON contract from the merchant.
   We now need to pass it to the extension. */
function handle_contract(json_contract)
{
  var cEvent = new CustomEvent('taler-contract', { detail: json_contract });

  document.dispatchEvent(cEvent);
};

function taler_pay(article)
{
  var contract_request = new XMLHttpRequest();

  /* Note that the URL we give here is specific to the Demo-shop
     and not required by the protocol: each web shop can
     have its own way of generating and transmitting the
     contract, there just must be a way to get the contract
     and to pass it to the wallet when the user selects 'Pay'. */
  contract_request.open("GET", "essay_contract.php?article=" + article, true);
  contract_request.onload = function (e)
  {
    if (contract_request.readyState == 4)
    {
      if (contract_request.status == 200)
      {
        /* display contract_requestificate (i.e. it sends the JSON string
          to the extension) alert (contract_request.responseText); */
	console.log("contract here");
        console.log("response text:", contract_request.responseText);
        handle_contract(contract_request.responseText);
      }
      else
      {
        /* There was an error obtaining the contract from the merchant,
           obviously this should not happen. To keep it simple, we just
           alert the user to the error. */
        alert("Failure to download contract from merchant " +
              "(" + contract_request.status + "):\n" +
              contract_request.responseText);
      }
    }
  };
  contract_request.onerror = function (e)
  {
    /* There was an error obtaining the contract from the merchant,
       obviously this should not happen. To keep it simple, we just
       alert the user to the error. */
    alert("Failure requesting the contract:\n" + contract_request.statusText);
  };
  contract_request.send(null);
}

/* The following event gets fired whenever a customer has a Taler
   wallet installed in his browser. In that case, the webmaster can decide
   whether or not to display/enable Taler as a payment option in the dialog. */
function has_taler_wallet_cb(aEvent)
{
  console.log("has taler wallet");
  // make "read more" trigger Taler payment
  var articles_links = document.getElementsByClassName("read-more");
  for(var i=0; i < articles_links.length; i++)
    //console.log(link);
    articles_links[i].setAttribute("href", "javascript:taler_pay(\"" + articles_links[i].id + "\")");
};

/* Function called when the Taler extension was unloaded;
   here we disable the Taler option and check "Lisa", as
   some "valid" option should always be selected. */
function taler_wallet_unload_cb(aEvent)
{
  var rm = document.getElementById("read-more");
  rm.setAttribute("href", "cc_payment.html");
};


/* The merchant signals its taler-friendlyness to the wallet,
   thereby causing the wallet to make itself more visible in the menu.
   This function should be called both when the page is loaded
   (i.e. via body's onload) and when we receive a "taler-load" signal
   (as the extension may be loaded/enabled after the page was loaded) */
function signal_taler_wallet_onload()
{
  var eve = new Event('taler-probe');
  document.dispatchEvent(eve);
};


// function included to be run to test the page despite a
// wallet not being present in the browser.  Enables the
// Taler option. NOT needed in real deployments.
function test_without_wallet(){
  var tbutton = document.getElementById("taler-radio-button-id");
  tbutton.removeAttribute("disabled");
};


// /////////////// Main logic run first ////////////////////////

// Register event to be triggered by the wallet as a response to our
// first event
document.addEventListener("taler-wallet-present",
                          has_taler_wallet_cb,
			  false);

// Register event to be triggered by the wallet when it gets enabled while
// the user is on the payment page
document.addEventListener("taler-load",
                          signal_taler_wallet_onload,
			  false);

// Register event to be triggered by the wallet when it is unloaded
document.addEventListener("taler-unload",
                          taler_wallet_unload_cb,
	                  false);
</script>
</html>
